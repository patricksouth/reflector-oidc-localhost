# A really down spec httpd conf file, suitable for running on localhost only - don't use on a real Apache server.

<VirtualHost *:80>
  ServerName http://localhost:80

  <Directory /var/www/html>
  </Directory>

  RewriteEngine On
  RewriteCond %{HTTPS} off
  RewriteRule ^ https://localhost%{REQUEST_URI} [R=302,L,QSA]
</VirtualHost>

<IfModule mod_ssl.c>
  <VirtualHost _default_:443>

  ServerName localhost

  DocumentRoot /var/www/html

  SSLEngine on
  SSLCertificateFile /etc/ssl/certs/server.crt
  SSLCertificateKeyFile /etc/ssl/private/server.key
  SSLProtocol all -SSLv2 -SSLv3
  SSLCipherSuite EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH
  SSLHonorCipherOrder on

#  Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains"

  ErrorLog ${APACHE_LOG_DIR}/error.log
  CustomLog ${APACHE_LOG_DIR}/access.log combined

  <FilesMatch "\.(cgi|shtml|phtml|php)$">
    SSLOptions +StdEnvVars
  </FilesMatch>

  LogLevel warn

#  ErrorDocument 404 /error.html
#  ErrorDocument 403 /error.html 
#  ErrorDocument 401 /error.html
  ErrorDocument 400 /error.php

  <Directory /var/www/html>
    AllowOverride FileInfo
    ErrorDocument 400 /error/oidc_error.php
    ErrorDocument 401 /error/401.php
    ErrorDocument 403 /error/403.php
    ErrorDocument 500 /error/500.php
  </Directory>

    <Directory /var/www/html/secure/>
      AuthType openid-connect
      <RequireAll>
        Require valid-user
      </RequireAll>
#      OIDCUnAuthAction auth
      LogLevel debug
      LogLevel auth_openidc:debug
    </Directory>

    <Directory /var/www/html/mfa>
      AuthType openid-connect

      # Enforce that the "acr" claim in the ID token matches the requested value
      <RequireAll>
        Require valid-user
        Require claim acr:https://refeds.org/profile/mfa
#        Require claim amr:mfa
#        OIDCPathAuthRequestParams acr_values=https://refeds.org/profile/mfa
#        OIDCPathAuthRequestParams acr=https://refeds.org/profile/mfa
        OIDCPathAuthRequestParams acr_values=https%3A%2F%2Frefeds.org%2Fprofile%2Fmfa
      </RequireAll>
      LogLevel debug
      LogLevel auth_openidc:debug
    </Directory>

  </VirtualHost>
</IfModule>
